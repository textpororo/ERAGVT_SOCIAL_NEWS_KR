;전투 커맨드 표시 및 처리

;커맨드 표시
@SHOW_USERCOM
RESETCOLOR
PRINTL 
;카테고리로 분류하는 경우
IF CONFIG_CHECK_SCREEN_F(2) > 0
	PRINTFORML 　┌──────\@TCVARn:8 == 0 ? ─ # ┬ \@─────────────────────────────────────┐
	PRINTPLAIN 　│
	PRINT  [810] 특수 
	;특수 커맨드 선택 중(구속 시)
	IF TCVARn:8 == 0 && TCVARn:0 == 0
		TCVARn:8 += 10
		PRINTPLAIN 　
		CALL PRINT_COMNAME, 44
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 45
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 46
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 73
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 47
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 성기 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 69
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 99
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 구속 
		ELSE
			PRINT  [830] 보조 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;특수 커맨드 선택 중
	ELSEIF TCVARn:8 == 0
		TCVARn:8 += 10
		PRINTPLAIN 　
		RESULT = 0
		TRYCALLFORM COM_ABLE{0}
		IF RESULT
			;거리 지정 변신
			TRYCALLFORM COM_ABLE{201}
			IF RESULT
				CALL PRINT_COMNAME, 201
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 202
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 203
			;통상 변신
			ELSE
				CALL PRINT_COMNAME, 0
			ENDIF
		ELSE
			;SP 변신
			TRYCALLFORM COM_ABLE{11}
			SIF RESULT
				CALL PRINT_COMNAME, 11
		ENDIF
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 성기 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 99
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 69
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 구속 
		ELSE
			PRINT  [830] 보조 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;성기 커맨드 선택 중(＝구속 시)
	ELSEIF  TCVARn:8 == 1 && TCVARn:0 == 0
		TCVARn:8 += 10
		PRINTPLAIN │
		CALL PRINT_COMNAME, 100
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 101
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 102
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, 103
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 104
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 성기 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN 　
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 구속 
		ELSE
			PRINT  [830] 보조 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;공격 커맨드 선택 중
	ELSEIF  TCVARn:8 == 1
		TCVARn:8 += 10
		PRINTPLAIN │
		CALL PRINT_COMNAME, 1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 2
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 3
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 성기 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN 　
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┐
		CALL PRINT_COMNAME, 74
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 구속 
		ELSE
			PRINT  [830] 보조 
		ENDIF
		PRINTPLAIN │
		TCVARn:8 -= 10
	;보조 커맨드 선택 중(구속 시)
	ELSEIF  TCVARn:8 == 2 && TCVARn:0 == 0
		TCVARn:8 += 10
		PRINTPLAIN │
		IF (TCVARn:12 & 강구속)
			CALL PRINT_COMNAME, 40
		ELSE
			CALL PRINT_COMNAME, 8
		ENDIF
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 9
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 10
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 11
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 12
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 13
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 성기 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 14
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 15
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 구속 
		ELSE
			PRINT  [830] 보조 
		ENDIF
		PRINTPLAIN 　
		TCVARn:8 -= 10
	;보조 커맨드 선택 중
	ELSEIF  TCVARn:8 == 2
		TCVARn:8 += 10
		PRINTPLAIN │
		CALL PRINT_COMNAME, 6
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 7
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 5
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┤
		CALL PRINT_COMNAME, 4
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [820] 성기 
		ELSE
			PRINT  [820] 공격 
		ENDIF
		PRINTPLAIN │
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　├──────┘
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　│
		PRINTL 

		PRINTPLAIN 　│
		IF TCVARn:0 == 0
			PRINT  [830] 구속 
		ELSE
			PRINT  [830] 보조 
		ENDIF
		PRINTPLAIN 　
		TCVARn:8 -= 10
	ENDIF
	PRINTPLAIN 　　　　　　　　　　　　　　
	PRINT 스테이터스 표시[800]
	PRINTPLAIN  　　　　　　　
	LOCALS = 
	SIF CHECK_CAN_RETREAT_F() == 0
		SETCOLOR 128,128,128
	SIF (TCVARn:0 > 0 && GETBATTLESITUATION("철수 불가") == 0 && (TCVARn:12 & 기절) == 0) || FLAG:999 == 1
		LOCALS = 철수[999]

	PRINTFORM %LOCALS, 9%
	RESETCOLOR
	PRINTPLAIN 　│
	PRINTL 
	PRINTFORML 　└──────\@TCVARn:8 == 2 ? ─ # ┴ \@─────────────────────────────────────┘
;모아서 표시하는 경우
ELSE
	TCVARn:8 += 10
	;구속되어 있는 중의 커맨드
	IF TCVARn:0 == 0
		CALL PRINT_COMNAME, 11
		PRINTL 
		PRINTL 
		IF (TCVARn:12 & 강구속)
			CALL PRINT_COMNAME, 40
		ELSE
			CALL PRINT_COMNAME, 8
		ENDIF
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 9
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 10
		PRINTPLAIN 　 
		PRINTL 

		CALL PRINT_COMNAME, 12
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 13
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 14
		PRINTPLAIN 　 
		PRINTL 

		RESULT = 0
		FOR LOCAL,44,47
			TRYCALLFORM COM_ABLE{LOCAL}
			IF RESULT
				CALL PRINT_COMNAME, LOCAL
				PRINTPLAIN 　 
			ENDIF
		NEXT
		PRINTL

		CALL PRINT_COMNAME, 70
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTPLAIN 　
		PRINTL 

		CALL PRINT_COMNAME, 100
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 101
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 102
		PRINTL 

		CALL PRINT_COMNAME, 103
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 104
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTL 

		CALL PRINT_COMNAME, 15
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTL 

	;통상시의 커맨드
	ELSE
		RESULT = 0
		TRYCALLFORM COM_ABLE{0}
		;변신 커맨드가 표시되는 상태
		IF RESULT
			;거리 지정 변신
			TRYCALLFORM COM_ABLE{201}
			IF RESULT

				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:30,"COM")
				PRINTFORM %"《위험도:"+(TCVARn:30>=0 ? TOSTR(TCVARn:30) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:31,"COM")
				PRINTFORM %"《위험도:"+(TCVARn:31>=0 ? TOSTR(TCVARn:31) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:32,"COM")
				PRINTFORM %"《위험도:"+(TCVARn:32>=0 ? TOSTR(TCVARn:32) # "??")+"%》", 22%
				RESETCOLOR
				PRINTL
				CALL PRINT_COMNAME, 201
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 202
				PRINTPLAIN 　 
				CALL PRINT_COMNAME, 203
				PRINTL
				PRINTFORM 　　　         ----------------------------------------------


			;통상 변신
			ELSE
				CALL PRINT_COMNAME, 0
			ENDIF
			PRINTL
		;변신 커맨드가 표시되지 않는 상태(통상 변신 완료or변신 불가)
		ELSE
			;가만히있는다
			TRYCALLFORM COM_ABLE{11}
			IF RESULT
				CALL PRINT_COMNAME, 11
				PRINTL
			ELSE

				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:30,"COM")
				PRINTFORM %"《위험도:"+(TCVARn:30>=0 ? TOSTR(TCVARn:30) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:31,"COM")
				PRINTFORM %"《위험도:"+(TCVARn:31>=0 ? TOSTR(TCVARn:31) # "??")+"%》", 22%
				PRINTPLAIN 　 
				CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:32,"COM")
				PRINTFORM %"《위험도:"+(TCVARn:32>=0 ? TOSTR(TCVARn:32) # "??")+"%》", 22%
				RESETCOLOR
				PRINTL

			ENDIF
		ENDIF

		CALL PRINT_COMNAME, 1
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 2
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 3
		PRINTL

		CALL PRINT_COMNAME, 6
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 7
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 5
		PRINTL
		;↑여기까지 거리 의존 커맨드
		PRINTL

		CALL PRINT_COMNAME, 4
		PRINTPLAIN 　 
		CALL FORECAST_OUTPUT_SETCOLOR(TCVARn:33,"COM")
		CALL PRINT_COMNAME, 16
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 17
		PRINTL 

		TRYCALLFORM COM_ABLE{73}
		;SP 변신
		IF RESULT
			CALL PRINT_COMNAME, 73
		;SP 버스트
		ELSE
			CALL PRINT_COMNAME, 70
		ENDIF

		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 71
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, 72
		PRINTL 

		CALL PRINT_COMNAME, 74
		PRINTPLAIN 　 
		CALL PRINT_COMNAME, -1
		PRINTPLAIN 　 
		TRYCALLFORM COM_ABLE{69}
		IF RESULT
			CALL PRINT_COMNAME, 69
		ENDIF
		PRINTL 
		PRINTL 
		PRINTL 
		

	ENDIF

	TCVARn:8 -= 10

	PRINT 　스테이터스 표시[800]

	SIF CHECK_CAN_RETREAT_F() == 0
		SETCOLOR 128,128,128
	SIF (TCVARn:0 > 0 && GETBATTLESITUATION("철수 불가") == 0 && (TCVARn:12 & 기절) == 0) || FLAG:999 == 1
		PRINT 　　　　　　　　철수[999]
	RESETCOLOR

	TCVARn:8 += 10
	PRINTPLAIN 　 
	CALL PRINT_COMNAME, 99
	TCVARn:8 -= 10
ENDIF


;커맨드 처리
@USERCOM
IF RESULT == 999 && ((TCVARn:0 > 0 && GETBATTLESITUATION("철수 불가") == 0 && (TCVARn:12 & 기절) == 0) || FLAG:999 == 1)
	IF CHECK_CAN_RETREAT_F()
		PRINTL 
		FONTBOLD
		SETCOLOR 0, 255, 150
		PRINTL ********** 아군의 행동 **********
		RESETCOLOR
		FONTREGULAR
		PRINTL 

		;철수
		IF ENEMY_TYPE_CHECK_F("AKUOTI") == 0
			CALL ACT_HANTEI_TETTAI_TENTACLE
			IF RESULT == 1
				;지문: 철수 성공
				CALL MESSAGE_BATTLE_CHARA_TETTAI_SUCCESS
				;지문: 세뇌/흑화 캐릭터가 조작 캐릭터의 철수를 막지 못했다
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_SUCCESS

				TRYCALL KYUSHUTU_SUCCESS_HANTEI
				;최종 보스 강화
				;TRYCALLFORM LASTBOSS_KYOUKA_{FLAG:11}_BATTLEEND,0
				BEGIN AFTERTRAIN
			ELSE
				;지문: 철수 실패
				CALL MESSAGE_BATTLE_CHARA_TETTAI_FALSE
				;지문: 세뇌/흑화 캐릭터가 조작 캐릭터의 철수를 막았다
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_FALSE
				JUMP SOURCE_CHECK
			ENDIF
		ELSE
			CALL ACT_HANTEI_TETTAI_TENTACLE
			IF RESULT == 1
				;지문: 철수 성공
				CALL MESSAGE_BATTLE_CHARA_TETTAI_SUCCESS
				;지문: 세뇌/흑화 캐릭터가 조작 캐릭터의 철수를 막지 못했다
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_SUCCESS
				
				BEGIN AFTERTRAIN
			ELSE
				;지문: 철수 실패
				CALL MESSAGE_BATTLE_CHARA_TETTAI_FALSE
				;지문: 세뇌/흑화 캐릭터가 조작 캐릭터의 철수를 막았다
				SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
					CALL MESSAGE_OTHER_BATTLE_CHARA_TETTAI_FALSE
				JUMP SOURCE_CHECK
			ENDIF
		ENDIF
	ELSE
	ENDIF
ELSEIF RESULT == 800
	DRAWLINE
	CALL SHOW_STATUS_CHARA_SELECT, TARGET
ELSEIF RESULT == 810
	TCVARn:8 = 0
ELSEIF RESULT == 820
	TCVARn:8 = 1
ELSEIF RESULT == 830
	TCVARn:8 = 2
;조교 스테이터스 표시설정
ELSEIF RESULT == 898
	INVERTBIT FLAG:801, 8
ELSEIF RESULT == 899
	INVERTBIT FLAG:801, 6
;디버그 모드 전환(숨김 커맨드)
ELSEIF RESULT == 400
	;DEBUG
	IF FLAG:999 == 0
		PRINTL 
		PRINTL 
		PRINTL DEBUG ON
		FLAG:999 = 1
		SETBGCOLOR 0,0,40
	ELSEIF FLAG:999 == 1
		PRINTL 
		PRINTL 
		PRINTL DEBUG OFF
		FLAG:999 = 0
		RESETBGCOLOR
	ENDIF
ELSEIF RESULT < 400
	LOCAL = RESULT
	TCVARn:8 += 10
	RESULT = 0
	TRYCALLFORM COM_ABLE{LOCAL}
	TCVARn:8 -= 10
	SIF RESULT
		DOTRAIN LOCAL
ENDIF

@EVENTCOM
;EX계는 표시하지 않는다
SIF SELECTCOM == 16 || SELECTCOM == 17 || SELECTCOM == 71 || SELECTCOM == 72
	RETURN 0
;사정 부위 플래그를 0으로
TFLAG:4 = 0
;방어 플래그를 지운다
TCVARn:2 = 자세：통상
;주고받기용 PALAM 초기화
VARSET COMMON_PALAM

PRINTL 
FONTBOLD
SETCOLOR 0, 255, 150
PRINTL ********** 아군의 행동 **********
RESETCOLOR
FONTREGULAR
PRINTL 

@EVENTCOMEND
#DIM LCOUNT
#DIM CCOUNT
;계산용
#DIM CHISEI_CAL
;PALAM 감쇠율(減衰率)
#DIM AT_VAR
CALL BATTLE_REPORT
;심경의 지속 턴을 카운트
SIF TCVARn:1 > 0
	TCVARn:11 += 1

;착지 중이거나 구속 중이라면 공중 플래그를 초기화
IF GETBIT(TCVARn:216, 2) || TCVARn:0 == 0
	TCVARn:216 = 0
	BASE:공중대시 = MAXBASE:공중대시
	SIF BASE:공중대시 >= 8
		BASE:공중대시 = 8
;체공 상태로 계속해서 공중대시를 사용하지 않는다면 착지 상태가 된다
;[에어마스터] FEAT의 추가 효과 발동 금지 플래그를 초기화
ELSEIF GETBIT(TCVARn:216, 1) && GETBIT(TCVARn:216, 0) == 0
	SETBIT TCVARn:216,2
	TCVARn:210 -= 추가발동금지
	SIF GETBIT(TCVARn:216, 1)
		TCVARn:216 -= 2
ENDIF

;공중대시 게이지가 다 떨어지면 공중 공격 플래그를 초기화
SIF GETBIT (TCVARn:216, 0) && BASE:공중대시 == 0
	TCVARn:216 -= 1

;버스트 공격 플래그는 항상 초기화
TCVARn:217 = 0

;구속 중이 아니라면 (통째로)삼키기 플래그를 해제
SIF TCVARn:0 != 0
	TFLAG:23 = 0

;구속 중이라면 동일 거리 플래그를 해제
SIF TCVARn:0 == 0
	TFLAG:30 = 0
;구속 중이라면 체인을 초기화
SIF TCVARn:0 == 0
	TFLAG:31 = 0
;방어 커맨드를 사용한 다음 턴은 카운터 어택
IF SELECTCOM == 4 && FLAG:73 == 0
	TFLAG:32 = 1
ELSE
	TFLAG:32 = 0
ENDIF

;의상 정보를 갱신
CALL REFRESH_CLOTH_DATA

;게이지 증감 관련
IF CFLAG:1 == 2
	TCVARn:6 += -17
ELSE
	TCVARn:6 += 12
	;상태 이상의 경우, 게이지 증가량 상승
	SIF (TCVARn:12 & 기절)
		TCVARn:6 += 23
	SIF (TCVARn:12 & 배란)
		TCVARn:6 += 3
	SIF (TCVARn:12 & 발정)
		TCVARn:6 += 3
	SIF (TCVARn:12 & 마비)
		TCVARn:6 += 8
	SIF (TCVARn:12 & 끈적끈적)
		TCVARn:6 += 5
	SIF (TCVARn:12 & 쓰러짐)
		TCVARn:6 += 8
	SIF (TCVARn:12 & 황홀)
		TCVARn:6 += 5
	SIF (TCVARn:12 & 강구속)
		TCVARn:6 += 2
	;증가량 UP계 보정
	IF TCVARn:6 > 0
		LOCAL = 0
		;변신 가능 캐릭터로 변신 전이라면 증가량 2배
		SIF TALENT:변신능력 > 0 && CFLAG:1 == 0
			LOCAL += 100
		;의욕 스위치#####
		SIF CFLAG:43 == 503
			LOCAL += 30
		;FEAT 효과에 의한 게이지 증가량 저하
		SIF TALENT:불굴 > 0
			LOCAL -= 15
		SIF TALENT:스태미나 > 0
			LOCAL -= 15
		;의상에 의한 게이지 증폭 효과
		CALL CLOTH_BATTLE_HOSEI, "EXBOOST"
		LOCAL += RESULT
		SIF LOCAL < -100
			LOCAL = -100
		TCVARn:6 = TCVARn:6 * (100 + LOCAL) / 100
	ENDIF
ENDIF

IF CFLAG:1 == 2
	TCVARn:5 += TCVARn:6
ELSE
	TCVARn:4 = LIMIT(TCVARn:4 + TCVARn:6, 0, 600)
	TCVARn:4 = LIMIT(TCVARn:4 + TCVARn:7, -100, 500)
ENDIF

;SP 변신 해제
IF TCVARn:5 <= 0 && CFLAG:1 == 2
	IF TALENT:변신능력
		CALL TRANSFORM, 1
	ELSE
		CALL TRANSFORM, 0
	ENDIF
	PRINTL 
	FONTBOLD
	;지문: SP 변신 해제, 그딴 건 없었다 ㅅㄱ
	PRINTFORML ＳＰ변신의 효과 시간이 종료됐다！
	FONTREGULAR
	TCVARn:4 = -1
	;행동의 반동으로 피로가 축적된다
	CFLAG:99 += TFLAG:99
	RESULTS = {TFLAG:99}
	TOFULL RESULTS
	PRINTFORML %PRINT_CALLNAME(TARGET)%의 신체 밑바닥에 피로가 쌓였다……（＋%RESULTS%）
	PRINTW 
	TFLAG:99 = 0
ENDIF

;게이지 사용 상황 플래그를 초기화
TCVARn:3 = 0
;양쪽의 증감을 초기화
TCVARn:6 = 0
TCVARn:7 = 0

;촉수의 굵기와 수를 보존
REPEAT 감각수
	TFLAG:(COUNT + 101) = TENTACLE_SIZE:0:COUNT
	TFLAG:(COUNT + 105) = TENTACLE_NUM:1:COUNT
REND
TFLAG:109 = INSERT
;촉수 사이즈 초기화
VARSET TENTACLE_SIZE

;절정에 의한 변신 해제, 성내성이 적을수록 발생률이 오른다
LOCAL:2 = 0
REPEAT 감각수
	LOCAL:2 += NOWEX:(COUNT)
REND
CALL PERCENT_CAL, BASE:기력, MAXBASE:기력
LOCAL:4 = RESULT
CALL PERCENT_CAL, BASE:성내성, MAXBASE:성내성
LOCAL:3 = 100 - (RESULT * 4 / 3)

;폭주 중인 촉수 슈트라면 해제되지 않는다
IF CFLAG:1 == 1 && CFLAG:41 == 199 && CFLAG:41 == 199 && TCVARn:41 != 0
;기력이 다하여 변신이 강제적으로 풀린 경우의 처리
ELSEIF CONFIG_CHECK_BALANCE_F(6) == 0 && CFLAG:1 == 1 && BASE:기력 <= 0 && (TCVARn:12 & 강구속) == 0
	PRINTL 
	;지문: 기력이 다하여 변신이 강제로 풀렸다
	CALL MESSAGE_BATTLE_CHARA_TRANSRELEASE
	;지문: 세뇌/흑화 캐릭터가 조작 캐릭터를 강제 변신 해제시켰다
	SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
		CALL MESSAGE_OTHER_BATTLE_CHARA_TRANSRELEASE
	CALL TRANSFORM, 0
	
	;심경 변화
	LOCAL = RAND:100
	IF LOCAL < 30
		CALL SHINKYOU_CHANGE, "IKARI_TEIKAN"
	ELSEIF LOCAL < 60
		CALL SHINKYOU_CHANGE, "REISEI_DOUYOU"
	ELSEIF LOCAL < 90
		CALL SHINKYOU_CHANGE, "KOUYOU_SYOUTIN"
	ENDIF
;절정으로 변신이 강제 해제될 경우의 처리
ELSEIF CONFIG_CHECK_BALANCE_F(6) == 0 && CFLAG:1 == 1 && LOCAL:2 > 0 && RAND:100 < LOCAL:3 && RESULT < 50 && (TCVARn:12 & 강구속) == 0
	PRINTL 
	;지문: 절정으로 변신이 강제로 풀렸다
	CALL MESSAGE_BATTLE_CHARA_TRANSRELEASE_ECS
	;지문: 세뇌/흑화 캐릭터가 조작 캐릭터를 절정으로 강제 변신 해제시켰다
	SIF ENEMY_TYPE_CHECK_F("AKUOTI") == 1
		CALL MESSAGE_OTHER_BATTLE_CHARA_TRANSRELEASE_ECS
	CALL TRANSFORM, 0

	;심경 변화
	LOCAL = RAND:100
	IF LOCAL < 30
		CALL SHINKYOU_CHANGE, "IKARI_TEIKAN"
	ELSEIF LOCAL < 60
		CALL SHINKYOU_CHANGE, "REISEI_DOUYOU"
	ELSEIF LOCAL < 90
		CALL SHINKYOU_CHANGE, "KOUYOU_SYOUTIN"
	ENDIF
ELSEIF CFLAG:1 == 1 && LOCAL:2 > 0 && RESULT < 50 && (TCVARn:12 & 기절) == 0
	PRINTL 
	PRINTFORML %조사처리(PRINT_TRANSCALLNAME(TARGET),"는")% 어떻게든 기력을 쥐어짜 변신을 유지했다！
ENDIF

;보스의 해석도를 지성의 기초치에 따라 상승시킨다 (실수치는 아님)
IF ENEMY_TYPE_CHECK_F("AKUOTI") == 0 && FLAG:20 < 100
	LOCAL = MAX(BASE:지성 - 100, 1)
	;전투 지원에 따른 보정
	CALL CALC_CHISEI_SHIEN(2)
	LOCAL = RESULT
	;심경에 따른 증감
	IF TCVARn:1 == 2
		LOCAL /= 2
	ELSEIF TCVARn:1 == 4
		LOCAL += 5
	ELSEIF TCVARn:1 == 5
		LOCAL /= 3
	ENDIF
	LOCAL = RAND:5 + LOCAL/4 + LOCAL:1
	CALL TENTACLE_LEVEL
	SIF RESULT < 10
		LOCAL += 10 - RESULT / 3
	SIF TCVARn:2 != 자세：통상
		LOCAL += 2 + RAND:5
	;스카우터#####
	SIF CFLAG:TARGET:43 == 500
		LOCAL += 5 + RAND:6
	PRINTL 
	IF LOCAL > 0
		DRAWLINE
		PRINTFORML 적의 해석도가 {LOCAL}％ 올랐다！
	ELSE
		DRAWLINE
		PRINTFORML 적의 해석도가 오르지 않았다……
	ENDIF
	SIF FLAG:20 < 25 && FLAG:20 + LOCAL >= 25
		PRINTL 적의 최대 체력이 판명났다！
	SIF FLAG:20 < 50 && FLAG:20 + LOCAL >= 50
		PRINTL 적의 현재 체력이 판명났다！
	SIF FLAG:20 < 75 && FLAG:20 + LOCAL >= 75
		PRINTL 적의 기초 능력치가 판명났다！
	IF FLAG:20 < 100 && FLAG:20 + LOCAL >= 100
		PRINTL 적의 행동 보정치가 판명났다！
		PRINTL 적의 방심도가 판명났다！
		PRINTL 적의 해석이 완료됐다！
	ENDIF
	FLAG:20 += LOCAL
	SIF FLAG:20 > 100
		FLAG:20 = 100
	PRINTL 
ENDIF
;EX에 NOWEX를 가산
REPEAT 감각수
	EX:(COUNT) += NOWEX:(COUNT)
REND

PREVCOM = SELECTCOM

;절정 금지 카운트
SIF TCVARn:0 == 0 && TCVARn:40 > 0
	TCVARn:40 -= 1

SETCOLOR 96, 96, 96
SIF FLAG:999 == 1
	PRINTFORML /* Debug */ 절정 금지 남은 턴 {TCVARn:40}
RESETCOLOR

AT_VAR = LIMIT(950 + PALAMLV_F(PALAM:공순) * 3 + PALAMLV_F(PALAM:욕정) * 3 + PALAMLV_F(PALAM:굴복) * 2 + PALAMLV_F(PALAM:공포) * 2, 950, 995)

;PALAM 최대값을 보존 및 PALAM의 감쇠(減衰)
FOR LCOUNT, 0, PALAM종점
	SIF PALAM:(LCOUNT) > MAX_PALAM:(LCOUNT)
		MAX_PALAM:(LCOUNT) = PALAM:(LCOUNT)

	SIF LCOUNT == 윤활
		CONTINUE
	PALAM:(LCOUNT) = PALAM:(LCOUNT) * AT_VAR / 1000
NEXT

;도망치지 못한 시민과 구경꾼이 줄어든다
LOCAL:1 = 0
FOR LOCAL,0,(FLAG:70 + FLAG:71)
	;일정 확률로 대피 완료
	IF RAND:100 < 5 + TFLAG:0 + (TIME == 0) * 5 + (GETBATTLESITUATION("정체 발각 불가") ? (FLAG:70 > 5 ? 50 # 15) # 0) && FLAG:70
		FLAG:70 -= 1
		LOCAL:1 += 1
	ENDIF
	IF RAND:100 < -10 + TFLAG:0 + (TIME == 0) * 5 + (FLAG:71 > 5 ? 50 # 0) && FLAG:71
		FLAG:71 -= 1
		LOCAL:1 += 1
	ENDIF
NEXT
IF LOCAL:1
	IF FLAG:72
		PRINTFORML 위험을 느낀 관중 {LOCAL:1}명이 급히 대피했다！
	ELSE
		PRINTFORML {LOCAL:1}명의 일반인이 안전한 장소까지 대피할 수 있었던 것 같다・・・
	ENDIF
	SIF FLAG:70 + FLAG:71 == 0
		PRINTFORML 아무래도 주변 시민들의 대피가 완료된 것 같다！
	PRINTW 
ENDIF

;이벤트 특유의 턴 엔드 처리
TRYCALLFORM EVENT_BATTLE_TURNEND_{FLAG:45}

;INSTANT 모드라면 능력 저하 함수를 호출한다
IF GAME_OPTION_CHECK_F(OPTION_스탯저하있음)
	CALL INSTANT_ARG_DOWN
ENDIF
